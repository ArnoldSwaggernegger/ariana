<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title></title>
    <script src="gl-matrix.js"></script>
    <script src="render-helper.js"></script>
    <script src="layer.js"></script>
    <script src="base-program.js"></script>
    <script src="image-layer.js"></script>
    <script src="image-shader-program.js"></script>
    <script src="render-engine.js"></script>
    <script src="drawbuffer.js"></script>

    <script>
        function start() {
            createGLContext("glcanvas");
            var image = new Image();
            var image2 = new Image();
            var canvas = document.getElementById("glcanvas");
            var renderEngine = new RenderEngine(canvas.width, canvas.height);

            var counter = 1;
            function done() {
                if (counter === 1) {
                    counter --;
                }
                else {
                    var imageLayer = new ImageLayer(image);
                    imageLayer.setScale(.5,.5);
                    imageLayer.setRotation(1.);
                    imageLayer.setPos(0,0.5);

                    var imageLayer2 = new ImageLayer(image2);
                    imageLayer2.setScale(.3,.3);
                    imageLayer2.setRotation(-1.);
                    imageLayer2.setPos(0.5,0);

                    renderEngine.addLayer(imageLayer);
                    renderEngine.addLayer(imageLayer2);
                    renderEngine.reorder(1, 0);
                    renderEngine.render();

                    var imageEl = document.getElementById("images");
                    imageEl.src = renderEngine.renderToImg();
                }
            }

            image2.src = "wall.png";
            image2.onload = done;

            image.src = "image.jpg";
            image.onload = done;
        }
    </script>
    <script id="image-shader-fs" type="x-shader/x-fragment">
        varying highp vec2 v_texCoord;

        uniform sampler2D u_sampler;

        void main(void) {
            gl_FragColor = texture2D(u_sampler, v_texCoord);
        }
    </script>
    <script id="brightness-fs" type="x-shader/x-fragment">
        precision mediump float;

        uniform float brightness = 0;
        uniform sampler2D u_sampler;
        varying vec2 v_texCoordinate;

        void main() {
	        vec4 texColor = texture2D(u_sampler, v_texCoordinate);
	        gl_FragColor = texColor * brightness + vec4(0, 0, 0, 1.0);
        }
    </script>
    <script id="image-shader-vs" type="x-shader/x-vertex">
    attribute vec2 a_position;
    attribute vec2 a_texCoord;

    varying highp vec2 v_texCoord;

    uniform mat3 u_matrix;
    uniform float u_depth;

    void main(void) {
      gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, u_depth, 1);
      v_texCoord = a_texCoord;
    }
    </script>
</head>

<body onload="start()">
<div id="canvas">
    <canvas id="glcanvas" width="640" height="640">
        Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
    </canvas>
</div>
<div id="filters"></div>
<div id="layers"></div>
<img id="images" />
</body>
</html>
